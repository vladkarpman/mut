<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report - {{test_name}}</title>
    <!-- Material Design 3 - Typography & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Material Symbols Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {{
            /* Material Design 3 - Dark Theme */
            --md-primary: #d0bcff;
            --md-primary-rgb: 208, 188, 255;
            --md-on-primary: #381e72;
            --md-primary-container: #4f378b;
            --md-on-primary-container: #eaddff;

            --md-secondary: #ccc2dc;
            --md-tertiary: #efb8c8;

            --md-surface: #141218;
            --md-surface-dim: #0e0d11;
            --md-surface-container-lowest: #0a090d;
            --md-surface-container-low: #1a181d;
            --md-surface-container: #1e1c22;
            --md-surface-container-high: #282629;
            --md-surface-container-highest: #333137;
            --md-on-surface: #e6e1e5;
            --md-on-surface-variant: #cac4d0;
            --md-outline: #938f99;
            --md-outline-variant: #49454f;

            --md-error: #f2b8b5;
            --md-error-container: #8c1d18;

            /* Status colors */
            --pass-color: #a8d5a2;
            --pass-bg: rgba(168, 213, 162, 0.16);
            --fail-color: #f2b8b5;
            --fail-bg: rgba(242, 184, 181, 0.16);
            --skip-color: #938f99;
            --skip-bg: rgba(147, 143, 153, 0.16);

            /* Action colors */
            --action-tap: #d0bcff;
            --action-tap-bg: rgba(208, 188, 255, 0.16);
            --action-swipe: #efb8c8;
            --action-swipe-bg: rgba(239, 184, 200, 0.16);
            --action-verify: #a8d5a2;
            --action-verify-bg: rgba(168, 213, 162, 0.16);
            --action-type: #90caf9;
            --action-type-bg: rgba(144, 202, 249, 0.16);
            --action-wait: #ffb957;
            --action-wait-bg: rgba(255, 185, 87, 0.16);

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Motion */
            --md-easing-standard: cubic-bezier(0.2, 0, 0, 1);
            --md-duration-short3: 150ms;
            --md-duration-short4: 200ms;
        }}

        .material-symbols-outlined {{
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 20px;
            vertical-align: middle;
        }}

        * {{ margin: 0; padding: 0; box-sizing: border-box; }}

        body {{
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--md-surface-dim);
            color: var(--md-on-surface);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }}

        /* Header */
        .header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-5);
            background: var(--md-surface-container);
            border-bottom: 1px solid var(--md-outline-variant);
        }}

        .header-left {{
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }}

        .header-meta {{
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 0.85rem;
            color: var(--md-on-surface-variant);
        }}

        .header-meta-item {{
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }}

        .header-meta-item .material-symbols-outlined {{
            font-size: 18px;
        }}

        .header-meta-divider {{
            color: var(--md-outline);
        }}

        .header-center {{
            display: flex;
            flex-direction: column;
            align-items: center;
        }}

        .header h1 {{
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }}

        .header-right {{
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }}

        .status-badge {{
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }}

        .status-badge.passed {{
            background: var(--pass-bg);
            color: var(--pass-color);
            border: 1px solid var(--pass-color);
        }}

        .status-badge.failed, .status-badge.error {{
            background: var(--fail-bg);
            color: var(--fail-color);
            border: 1px solid var(--fail-color);
        }}

        .export-btn {{
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--md-duration-short3) var(--md-easing-standard);
        }}

        .export-btn:hover {{
            background: #e8d6ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }}

        /* Main Layout - Video Left, Steps Right */
        .main {{
            display: flex;
            height: calc(100vh - 56px);
        }}

        /* Video Panel (Left) */
        .video-panel {{
            width: 320px;
            min-width: 280px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            background: var(--md-surface-container);
            border-right: 1px solid var(--md-outline-variant);
        }}

        .video-container {{
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-4);
        }}

        .video-wrapper {{
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: var(--md-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }}

        .video-wrapper video {{
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
        }}

        .no-video {{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            color: var(--md-on-surface-variant);
            text-align: center;
            min-height: 300px;
        }}

        .no-video .material-symbols-outlined {{
            font-size: 48px;
            opacity: 0.5;
            margin-bottom: var(--space-3);
        }}

        /* Steps Panel (Right) */
        .steps-panel {{
            flex: 1;
            overflow-y: auto;
            padding: var(--space-5);
        }}

        /* Step Card */
        .step-card {{
            background: var(--md-surface-container);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            border: 1px solid var(--md-outline-variant);
            overflow: hidden;
            transition: all var(--md-duration-short4) var(--md-easing-standard);
        }}

        .step-card:hover {{
            border-color: var(--md-outline);
        }}

        .step-card.active {{
            border-color: var(--md-primary);
            box-shadow: 0 0 0 3px rgba(208, 188, 255, 0.2);
        }}

        /* Step Header */
        .step-header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--md-outline-variant);
            cursor: pointer;
        }}

        .step-title {{
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }}

        .step-number {{
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }}

        .step-number.passed {{ background: var(--pass-color); color: #1a1a1a; }}
        .step-number.failed {{ background: var(--fail-color); color: #1a1a1a; }}
        .step-number.skipped {{ background: var(--skip-color); color: #1a1a1a; }}

        .gesture-badge {{
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'IBM Plex Mono', monospace;
        }}

        .gesture-badge .material-symbols-outlined {{
            font-size: 16px;
        }}

        .gesture-badge.tap {{ background: var(--action-tap-bg); color: var(--action-tap); }}
        .gesture-badge.doubletap {{ background: var(--action-tap-bg); color: var(--action-tap); }}
        .gesture-badge.longpress {{ background: var(--action-tap-bg); color: var(--action-tap); }}
        .gesture-badge.swipe {{ background: var(--action-swipe-bg); color: var(--action-swipe); }}
        .gesture-badge.verify, .gesture-badge.verifyscreen {{ background: var(--action-verify-bg); color: var(--action-verify); }}
        .gesture-badge.wait, .gesture-badge.waitfor {{ background: var(--action-wait-bg); color: var(--action-wait); }}
        .gesture-badge.type {{ background: var(--action-type-bg); color: var(--action-type); }}
        .gesture-badge.scrollto {{ background: var(--action-type-bg); color: var(--action-type); }}
        .gesture-badge.launchapp {{ background: var(--action-tap-bg); color: var(--action-tap); }}
        .gesture-badge.terminateapp {{ background: var(--fail-bg); color: var(--fail-color); }}
        .gesture-badge.back {{ background: var(--action-wait-bg); color: var(--action-wait); }}
        .gesture-badge.hidekeyboard {{ background: var(--action-wait-bg); color: var(--action-wait); }}

        .step-action-title {{
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--md-on-surface);
        }}

        .step-status {{
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }}

        .step-duration {{
            font-size: 0.8rem;
            color: var(--md-on-surface-variant);
            font-family: 'IBM Plex Mono', monospace;
        }}

        .step-status-indicator {{
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }}

        .step-status-indicator.passed {{
            background: var(--pass-bg);
            color: var(--pass-color);
        }}

        .step-status-indicator.failed {{
            background: var(--fail-bg);
            color: var(--fail-color);
        }}

        .step-status-indicator.skipped {{
            background: var(--skip-bg);
            color: var(--skip-color);
        }}

        .step-status-indicator .material-symbols-outlined {{
            font-size: 18px;
        }}

        /* Step Content */
        .step-content {{
            padding: var(--space-4);
        }}

        /* Frame Display - 3 Column Story Layout (matching approval.html) */
        .step-frames {{
            display: flex;
            gap: 16px;
            align-items: stretch;
        }}

        /* 2-column fallback for steps without action frames */
        .step-frames.two-column {{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }}

        .frame-column {{
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--md-surface-container);
            border-radius: var(--radius-xl);
            overflow: hidden;
            border: 1px solid var(--md-outline-variant);
            transition: all var(--md-duration-short3) var(--md-easing-standard);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }}

        .frame-column.before {{
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
        }}

        .frame-column.action {{
            background: var(--md-surface-container);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 2px var(--md-primary-container);
            z-index: 1;
        }}

        .frame-column.after {{
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
        }}

        .frame-column-header {{
            padding: 14px 16px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }}

        .frame-column.before .frame-column-header {{
            background: var(--md-surface-container-high);
            color: var(--md-on-surface-variant);
            border-bottom: 1px solid var(--md-outline-variant);
        }}

        .frame-column.action .frame-column-header {{
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            font-weight: 700;
            letter-spacing: 0.12em;
        }}

        .frame-column.after .frame-column-header {{
            background: rgba(168, 213, 162, 0.25);
            color: var(--pass-color);
            border-bottom: 1px solid rgba(168, 213, 162, 0.3);
        }}

        .frame-image-container {{
            position: relative;
            width: 100%;
            background: var(--md-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            cursor: pointer;
        }}

        .frame-image-container img {{
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
        }}

        .frame-placeholder {{
            color: var(--md-on-surface-variant);
            font-size: 0.8rem;
            text-align: center;
            padding: var(--space-5);
        }}

        /* Error/Failure Section */
        .step-failure {{
            margin-top: var(--space-4);
            padding: var(--space-4);
            background: var(--fail-bg);
            border: 1px solid rgba(242, 184, 181, 0.3);
            border-radius: var(--radius-lg);
        }}

        .failure-header {{
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            color: var(--fail-color);
            font-weight: 600;
            font-size: 0.85rem;
        }}

        .failure-header .material-symbols-outlined {{
            font-size: 20px;
        }}

        .failure-error {{
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            color: var(--fail-color);
            background: var(--md-surface);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            white-space: pre-wrap;
            word-break: break-word;
        }}

        .failure-suggestion {{
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }}

        .failure-suggestion-label {{
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            letter-spacing: 0.5px;
        }}

        .failure-suggestion-text {{
            font-size: 0.9rem;
            color: var(--md-on-surface);
            line-height: 1.5;
        }}

        /* AI Analysis Section */
        .step-ai-analysis {{
            margin-top: var(--space-4);
            padding: var(--space-4);
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--radius-lg);
        }}

        .step-ai-analysis.verified {{
            border-color: var(--pass-color);
            background: rgba(168, 213, 162, 0.08);
        }}

        .step-ai-analysis.not-verified {{
            border-color: var(--fail-color);
            background: rgba(242, 184, 181, 0.08);
        }}

        .ai-header {{
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--md-primary);
        }}

        .step-ai-analysis.verified .ai-header {{
            color: var(--pass-color);
        }}

        .step-ai-analysis.not-verified .ai-header {{
            color: var(--fail-color);
        }}

        .ai-header .material-symbols-outlined {{
            font-size: 20px;
        }}

        .ai-outcome {{
            font-size: 0.9rem;
            color: var(--md-on-surface);
            line-height: 1.5;
        }}

        /* AI Observation Section (for non-verification steps) */
        .step-ai-observation {{
            margin-top: var(--space-4);
            padding: var(--space-3) var(--space-4);
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--radius-md);
            opacity: 0.8;
        }}

        .ai-observation-header {{
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-weight: 500;
            font-size: 0.75rem;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }}

        .ai-observation-header .material-symbols-outlined {{
            font-size: 16px;
            opacity: 0.7;
        }}

        .ai-observation-text {{
            font-size: 0.85rem;
            color: var(--md-on-surface-variant);
            line-height: 1.5;
        }}

        /* Image Modal */
        .image-modal {{
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }}

        .image-modal.active {{
            display: flex;
        }}

        .image-modal img {{
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: var(--radius-lg);
        }}

        .image-modal-close {{
            position: absolute;
            top: var(--space-5);
            right: var(--space-5);
            background: var(--md-surface-container-high);
            border: none;
            color: var(--md-on-surface);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }}

        .image-modal-close:hover {{
            background: var(--md-surface-container-highest);
        }}

        /* ═══════════════════════════════════════════════════════════
           Enhanced Gesture Indicators - Material Touch Feedback
           ═══════════════════════════════════════════════════════════ */

        /* Gesture indicator container */
        .gesture-indicator-container {{
            position: absolute;
            /* Will be positioned by JavaScript to match actual image bounds */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }}

        /* Tap indicator - High contrast with dark outline */
        .tap-indicator {{
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--md-primary);
            border: 3px solid #fff;
            box-shadow:
                0 0 0 2px rgba(0, 0, 0, 0.8),
                0 4px 12px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(208, 188, 255, 0.6);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: tapBounce 1.5s cubic-bezier(0.34, 1.56, 0.64, 1) infinite;
        }}

        /* Inner dot */
        .tap-indicator::before {{
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }}

        /* Ripple ring */
        .tap-indicator::after {{
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: tapRipple1 1.5s ease-out infinite;
        }}

        @keyframes tapBounce {{
            0%, 100% {{
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 12px rgba(208, 188, 255, 1));
            }}
            50% {{
                transform: translate(-50%, -50%) scale(0.85);
                filter: drop-shadow(0 0 20px rgba(208, 188, 255, 1));
            }}
        }}

        @keyframes tapRipple1 {{
            0% {{
                transform: translate(-50%, -50%) scale(0.6);
                opacity: 1;
            }}
            100% {{
                transform: translate(-50%, -50%) scale(1.6);
                opacity: 0;
            }}
        }}

        /* Long press indicator - High contrast progress ring */
        .long-press-indicator {{
            position: absolute;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.4);
            border: 3px solid #fff;
            box-shadow:
                0 0 0 2px rgba(0, 0, 0, 0.8),
                0 4px 16px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(208, 188, 255, 0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }}

        /* Inner dot */
        .long-press-indicator::before {{
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 18px;
            height: 18px;
            background: var(--md-primary);
            border: 2px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: longPressPulse 1s ease-in-out infinite;
        }}

        /* Animated progress arc */
        .long-press-indicator::after {{
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            width: calc(100% + 6px);
            height: calc(100% + 6px);
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--md-primary);
            border-right-color: var(--md-primary);
            box-sizing: border-box;
            animation: longPressProgress 1.5s linear infinite;
            filter: drop-shadow(0 0 6px rgba(208, 188, 255, 0.8));
        }}

        @keyframes longPressPulse {{
            0%, 100% {{ transform: translate(-50%, -50%) scale(1); }}
            50% {{ transform: translate(-50%, -50%) scale(0.8); }}
        }}

        @keyframes longPressProgress {{
            0% {{
                transform: rotate(0deg);
            }}
            100% {{
                transform: rotate(360deg);
            }}
        }}

        /* Double tap indicator */
        .double-tap-indicator {{
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }}

        .double-tap-indicator .tap-circle {{
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            background: rgba(245, 158, 11, 0.7);
            box-shadow: 0 0 0 2px var(--action-tap), 0 2px 8px rgba(0,0,0,0.3);
        }}

        .double-tap-indicator .tap-1 {{
            top: -14px;
            left: -14px;
            animation: doubleTap1 1s ease-in-out infinite;
        }}

        .double-tap-indicator .tap-2 {{
            top: -6px;
            left: -6px;
            animation: doubleTap2 1s ease-in-out infinite;
        }}

        @keyframes doubleTap1 {{
            0%, 100% {{ transform: scale(1); opacity: 1; }}
            25% {{ transform: scale(0.7); opacity: 0.4; }}
            50% {{ transform: scale(1); opacity: 1; }}
            75% {{ transform: scale(1); opacity: 1; }}
        }}

        @keyframes doubleTap2 {{
            0%, 100% {{ transform: scale(0.8); opacity: 0.6; }}
            25% {{ transform: scale(0.8); opacity: 0.6; }}
            50% {{ transform: scale(0.7); opacity: 0.4; }}
            75% {{ transform: scale(1); opacity: 1; }}
        }}

        /* Swipe indicator - Modern gradient trail */
        .swipe-indicator {{
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }}

        /* Trajectory line - smooth gradient with glow */
        .swipe-indicator .swipe-trajectory-line {{
            position: absolute;
            left: var(--start-x);
            top: var(--start-y);
            width: var(--line-length);
            height: 3px;
            background: linear-gradient(
                90deg,
                rgba(208, 188, 255, 0.1) 0%,
                rgba(208, 188, 255, 0.4) 20%,
                rgba(208, 188, 255, 0.8) 80%,
                var(--md-primary) 100%
            );
            transform-origin: 0 50%;
            transform: rotate(var(--line-angle)) translateY(-50%);
            border-radius: 2px;
            filter: drop-shadow(0 0 6px rgba(208, 188, 255, 0.5));
            animation: swipeTrailPulse 1.8s ease-in-out infinite;
        }}

        /* Arrow at end of swipe */
        .swipe-indicator .swipe-trajectory-line::after {{
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid var(--md-primary);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            filter: drop-shadow(0 0 4px rgba(208, 188, 255, 0.8));
        }}

        /* Animated dot with comet trail */
        .swipe-indicator .swipe-dot {{
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 30%, var(--md-primary) 100%);
            transform: translate(-50%, -50%);
            left: var(--start-x);
            top: var(--start-y);
            animation: swipeMove 1.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            filter: drop-shadow(0 0 10px rgba(208, 188, 255, 0.9));
        }}

        /* Comet trail effect */
        .swipe-indicator .swipe-dot::before {{
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            width: 30px;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(208, 188, 255, 0.8));
            transform: translateY(-50%);
            border-radius: 2px;
            opacity: 0;
            animation: swipeTrail 1.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }}

        .swipe-indicator .swipe-dot::after {{
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }}

        @keyframes swipeTrailPulse {{
            0%, 70%, 100% {{ opacity: 1; }}
            50% {{ opacity: 0.7; }}
        }}

        @keyframes swipeMove {{
            0% {{
                left: var(--start-x);
                top: var(--start-y);
                transform: translate(-50%, -50%) scale(1);
            }}
            5% {{
                transform: translate(-50%, -50%) scale(0.8);
            }}
            45% {{
                left: var(--end-x);
                top: var(--end-y);
                transform: translate(-50%, -50%) scale(1.1);
            }}
            50% {{
                left: var(--end-x);
                top: var(--end-y);
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }}
            55% {{
                opacity: 0;
            }}
            56% {{
                left: var(--start-x);
                top: var(--start-y);
                opacity: 0;
            }}
            70%, 100% {{
                left: var(--start-x);
                top: var(--start-y);
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }}
        }}

        @keyframes swipeTrail {{
            0%, 56%, 100% {{ opacity: 0; width: 20px; }}
            10% {{ opacity: 0.8; }}
            45% {{ opacity: 0.8; width: 40px; }}
            55% {{ opacity: 0; }}
        }}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="header-meta">
                <span class="header-meta-item">
                    <span class="material-symbols-outlined">touch_app</span>
                    <span>{{summary_total}} steps</span>
                </span>
                <span class="header-meta-divider">|</span>
                <span class="header-meta-item passed">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span style="color: var(--pass-color)">{{summary_passed}}</span>
                </span>
                <span class="header-meta-divider">|</span>
                <span class="header-meta-item failed">
                    <span class="material-symbols-outlined">cancel</span>
                    <span style="color: var(--fail-color)">{{summary_failed}}</span>
                </span>
                <span class="header-meta-divider">|</span>
                <span class="header-meta-item">
                    <span class="material-symbols-outlined">schedule</span>
                    <span>{{duration}}</span>
                </span>
            </div>
        </div>
        <div class="header-center">
            <h1>{{test_name}}</h1>
        </div>
        <div class="header-right">
            <span class="status-badge {{status_class}}">
                <span class="material-symbols-outlined">{{status_icon}}</span>
                {{status}}
            </span>
            <button class="export-btn" onclick="exportJSON()">
                <span class="material-symbols-outlined">download</span>
                Export
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Video Panel (Left) -->
        {{video_html}}

        <!-- Steps Panel (Right) -->
        <div class="steps-panel" id="stepsPanel">
            {{steps_html}}
        </div>
    </main>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
        <img id="modalImage" src="" alt="Screenshot">
    </div>

    <script>
        const reportData = {{json_data}};
        let activeStepIndex = -1;
        const stepCards = document.querySelectorAll('.step-card');

        function exportJSON() {{
            const blob = new Blob([JSON.stringify(reportData, null, 2)], {{ type: 'application/json' }});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = reportData.test + '_report.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }}

        function selectStep(index) {{
            stepCards.forEach(card => card.classList.remove('active'));
            activeStepIndex = index;
            if (stepCards[index]) {{
                stepCards[index].classList.add('active');
                stepCards[index].scrollIntoView({{ behavior: 'smooth', block: 'nearest' }});

                const video = document.getElementById('reportVideo');
                const timestamp = stepCards[index].dataset.timestamp;
                if (video && timestamp) {{
                    video.currentTime = parseFloat(timestamp);
                }}
            }}
        }}

        document.addEventListener('keydown', function(e) {{
            if (e.key === 'ArrowDown') {{
                e.preventDefault();
                if (activeStepIndex < stepCards.length - 1) selectStep(activeStepIndex + 1);
            }} else if (e.key === 'ArrowUp') {{
                e.preventDefault();
                if (activeStepIndex > 0) selectStep(activeStepIndex - 1);
            }} else if (e.key === 'Escape') {{
                closeImageModal();
            }}
        }});

        function openImageModal(src) {{
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = src;
            modal.classList.add('active');
        }}

        function closeImageModal() {{
            document.getElementById('imageModal').classList.remove('active');
        }}

        stepCards.forEach((card, index) => {{
            card.querySelector('.step-header').addEventListener('click', () => selectStep(index));
        }});

        /**
         * Calculate the actual rendered image bounds for an img with object-fit: contain.
         * Returns {{ x, y, width, height }} of the actual image content within the element.
         */
        function getRenderedImageBounds(img) {{
            const imgRect = img.getBoundingClientRect();
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;

            if (!naturalWidth || !naturalHeight) {{
                // Image not loaded yet, return element bounds
                return {{ x: 0, y: 0, width: imgRect.width, height: imgRect.height }};
            }}

            // Calculate how the image is scaled to fit (object-fit: contain)
            const elementAspect = imgRect.width / imgRect.height;
            const imageAspect = naturalWidth / naturalHeight;

            let renderedWidth, renderedHeight, offsetX, offsetY;

            if (imageAspect > elementAspect) {{
                // Image is wider than element - letterbox top/bottom
                renderedWidth = imgRect.width;
                renderedHeight = imgRect.width / imageAspect;
                offsetX = 0;
                offsetY = (imgRect.height - renderedHeight) / 2;
            }} else {{
                // Image is taller than element - letterbox left/right
                renderedHeight = imgRect.height;
                renderedWidth = imgRect.height * imageAspect;
                offsetX = (imgRect.width - renderedWidth) / 2;
                offsetY = 0;
            }}

            return {{
                x: offsetX,
                y: offsetY,
                width: renderedWidth,
                height: renderedHeight
            }};
        }}

        /**
         * Position gesture indicators relative to actual rendered image bounds.
         * This accounts for object-fit: contain scaling and flexbox centering.
         */
        function positionGestureIndicators() {{
            document.querySelectorAll('.frame-image-container').forEach(container => {{
                const img = container.querySelector('img');
                const indicatorContainer = container.querySelector('.gesture-indicator-container');
                if (!img || !indicatorContainer) return;

                // Wait for image to load if not already
                if (!img.complete) {{
                    img.onload = () => requestAnimationFrame(() =>
                        requestAnimationFrame(() => positionIndicator(container, img, indicatorContainer))
                    );
                    return;
                }}

                // Double requestAnimationFrame ensures layout is fully settled
                requestAnimationFrame(() =>
                    requestAnimationFrame(() => positionIndicator(container, img, indicatorContainer))
                );
            }});
        }}

        function positionIndicator(container, img, indicatorContainer) {{
            // Get the actual rendered image bounds (accounting for object-fit: contain)
            const bounds = getRenderedImageBounds(img);

            // Get position of img element relative to container (accounts for flex centering)
            const imgRect = img.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            const imgOffsetX = imgRect.left - containerRect.left;
            const imgOffsetY = imgRect.top - containerRect.top;

            // Position indicator container to match actual rendered image content
            // Add both the element offset (flex centering) and the letterbox offset
            indicatorContainer.style.left = (imgOffsetX + bounds.x) + 'px';
            indicatorContainer.style.top = (imgOffsetY + bounds.y) + 'px';
            indicatorContainer.style.width = bounds.width + 'px';
            indicatorContainer.style.height = bounds.height + 'px';
        }}

        // Position indicators on load and resize
        positionGestureIndicators();
        window.addEventListener('resize', positionGestureIndicators);
    </script>
</body>
</html>
